#!/bin/sh
if [ "`dirname $0`" = "." ]; then
  ADJFIELD=./adjfield
  RUNFORM=../runform/runform
  FORMAXFRM=formax.frm
else
  ADJFIELD=adjfield
  RUNFORM=runform
  FORMAXFRM=${ARX:-/opt/arx}/lib/formax.frm
fi
FORM=$1
if ! cp -v $FORM.frm $FORM.frm.bac; then
  echo "$FORM.frm not found" >&2
  exit 2
fi
SQL="sqlite3 -batch $FORM.frm"
$SQL "select mtext from maps order by line" >$FORM.map
${EDITOR:-vi} $FORM.map
$SQL "delete from maps"
LINE=0
IFS=% sed "s/^/'/;s/\$/'/" $FORM.map | while read TEXT; do
  LINE=`expr $LINE + 1`
  $SQL "insert into maps (line, mtext) values ($LINE, $TEXT)"
done
$ADJFIELD <$FORM.map | $SQL
rm $FORM.map
$RUNFORM -x $FORMAXFRM $FORM.frm
$SQL .dump >$FORM.inp
${EDITOR:-vi} $FORM.inp
rm $FORM.frm
$SQL <$FORM.inp
exit
